<!DOCTYPE html>
<html lang="en">
<head>
    <title>r3f character controller demo</title>

    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://ordinals.com/content/c0de75106d9fab0dfe69060aac6248cfad9e4a3ad8375ce1d31b007e30ddfd5ci0"></script>
    <script src="https://ordinals.com/content/609b117277f1e9c9f27f358fe02db34e13d08915bbcea18770dc36f5f3afcbb2i2"></script>
    <script src="https://ordinals.com/content/04813d7748d918bd8a3069cb1823ebc9586f0ce16cd6a97a784581ec38d13062i0"></script>

    <meta name="theme-color" content="#333" />

  <script type="module" crossorigin>import{jsxs as M,jsx as c,Fragment as se}from"react/jsx-runtime";import ft,{useEffect as C,useRef as w,useCallback as oe,forwardRef as q,useState as X,useImperativeHandle as ee,memo as ce,Suspense as St,useLayoutEffect as Tt,useMemo as te,createElement as Ft}from"react";import Et from"react-dom/client";import{QUATERNIUS_ANIMATIONS_1 as Lt,QUATERNIUS_ANIMATIONS_2 as Ct,WorldLoader as Ut}from"/content/609dacfa9f257635b4f25a6196a4cbed59701462fa27925bf7554d24bebeeeb9i0";import{makeStore as Wt,useStore as Bt}from"statery";import{useEntities as Vt}from"miniplex-react";import{useFrame as G,useThree as ye,extend as jt}from"@react-three/fiber";import{ECS as j,useGUI as It}from"/content/eccced167a28a837669318b8b3446cc7570d42fcb16f973981504a25b947fefbi0";import{useSpring as ge}from"/content/c36976f076375baa6e7d778879b466baaf0b49e87af8808cff6d08239049376ei0";import{EffectComposer as Nt,SMAA as Ot,BrightnessContrast as Gt,HueSaturation as Qt}from"@react-three/postprocessing";import{useTexture as N,Environment as Xt,CameraControls as Yt,shaderMaterial as Kt,Instances as Zt,Instance as nt,Loader as Jt}from"@react-three/drei";import*as r from"three";import{Vector3 as re,Color as Z}from"three";import he from"three-custom-shader-material";import{toLinear as be,snoise as _,iqnoise as qt}from"/content/f4207b8dd437c7ae421756397d1b5022a0caa6b7b4908cb0f174587d0da69625i0";import{composable as mt,modules as V}from"material-composer-r3f";import{between as O,plusMinus as $}from"randomish";import{useParticleLifetime as vt,useParticleAttribute as J,InstancedParticles as wt,Emitter as yt}from"vfx-composer-r3f";import{Gradient as gt,Rotation3DZ as ht,Mul as ie,Rotation3DY as bt}from"shader-composer";import{DRACOLoader as at,GLTFLoader as Ht}from"/content/d3d336842ef829556f1c76f12e6ed13e272fe0274f29bd1dfc46e2112304d3ffi0";import{VRMUtils as H,VRMLoaderPlugin as _t}from"/content/fadedcce9d4515191d430a8b787d18062e2b98fc26b799abcbb7dfbe6ffa9addi0";import{VRMAnimationLoaderPlugin as $t,VRMLookAtQuaternionProxy as eo,createVRMAnimationClip as it}from"/content/aaaa206e1e9e60c954779e4410b5c429cac4ec85ae49317c735b6a8a3cb56512i0";import{loadMixamoAnimation as to}from"/content/609b9d7e45010b9c4fe894089d7de52bf69134b39a42d073839aed5c2081f6afi0";import{colliderStore as st,useCollider as xt}from"/content/a2fc9311fabf1243566aaeb4f1c7bcc62b72849b82fd358ed2cc00a61a582c7di0";import{createNoise2D as oo}from"simplex-noise";import Pt from"/content/2222a03a58f7c28eb988de0ecae76d1aaee07203a0dbe1e0a7ab0b1bd8883caai0";import ro from"alea";import{useDrag as no}from"@use-gesture/react";const ao=()=>{const o=Vt(j.world.with("render"));G(()=>{var t;for(const n of o){const{render:i,position:s,rotation:e,scale:d}=n;(t=i==null?void 0:i.group)!=null&&t.current&&(s&&i.group.current.position.set(s.x,s.y,s.z),e&&i.group.current.rotation.set(e.x,e.y,e.z),d&&i.group.current.scale.set(d.x,d.y,d.z))}})};window.keyDown={};const io=()=>(C(()=>{const o=n=>{if(window.isAceEditorFocused)return;const i=n.key.toLowerCase();i==="tab"&&(n.stopPropagation(),n.preventDefault()),i===" "?window.keyDown.space=!0:window.keyDown[i]=!0},t=n=>{if(window.isAceEditorFocused)return;const i=n.key.toLowerCase();i===" "?window.keyDown.space=!1:window.keyDown[i]=!1};return window.addEventListener("keydown",o),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",o),window.removeEventListener("keyup",t)}},[]),null);function so({onKeyDown:o={},onKeyUp:t={}}){const n=w({}),i=oe(e=>{if(window.isAceEditorFocused)return;const d=e.key.toLowerCase();o[d]&&o[d](e)},[o]),s=oe(e=>{if(window.isAceEditorFocused)return;const d=e.key.toLowerCase();t[d]&&t[d](e)},[t]);return C(()=>(window.addEventListener("keydown",i),window.addEventListener("keyup",s),()=>{window.removeEventListener("keydown",i),window.removeEventListener("keyup",s)}),[i,s]),n.current}const ne=(o,t,n)=>{const i=j.useCurrentEntity(),[s,e]=ge(()=>({[t]:n,config:{mass:1.1,friction:21,tension:369},onChange:d=>{i&&o.current&&(o.current.uniforms.get(t).value=d.value[t])}}));return{set:(d,a)=>{e.start({[t]:d,config:a})},stop:()=>{e.stop()}}},co=q((o,t)=>{const n=w(),[i,s]=X(2),e=w(),d=w(),a=w(),f=w(),y=w(),p=w(),b=ne(e,"brightness",0),v=ne(e,"contrast",0),g=ne(d,"saturation",0),m=ne(a,"darkness",0);return ee(t,()=>({group:n,multisampling:i,setMultisampling:s,brightnessContrast:e,hueSaturation:d,vignette:a,bloom:f,dof:y,chromatic:p,springs:{brightness:b,contrast:v,saturation:g,vignette:m}})),M(Nt,{ref:t,multisampling:i,children:[c(Ot,{preset:1,edgeDetectionMode:1}),c(Gt,{ref:e,brightness:.1,contrast:.2}),c(Qt,{ref:d,saturation:.1})]})}),lo=()=>M(j.Entity,{children:[c(j.Component,{name:"isPostprocessing",data:!0}),c(j.Component,{name:"render",children:c(co,{})})]}),uo=()=>c(lo,{}),kt=ce(()=>{const o=w(),t=w(),n=N("/content/70be267fbcf5503bfde5c20690fdc61d24f4be288f712c429b2d9d0c538c9f30i0"),i=N("/content/60939768343608ff9735b61222ed452726237748fa4e46aa0e2a7982cd35afbai0");return C(()=>{n.wrapS=n.wrapT=r.RepeatWrapping,n.repeat.set(1,1),n.encoding=r.sRGBEncoding,n.premultiplyAlpha=!1,n.format=r.RGBAFormat,n.anisotropy=0,n.needsUpdate=!0,i.wrapS=i.wrapT=r.RepeatWrapping,i.repeat.set(1,1),i.encoding=r.sRGBEncoding,i.premultiplyAlpha=!1,i.format=r.RGBAFormat,i.anisotropy=0,i.needsUpdate=!0},[n,i]),G(s=>{const e=t.current;e&&(s.clock.running&&(e.uniforms.time.value=s.clock.elapsedTime),window.playerPos&&(o.current.position.y=-5e3-window.playerPos.y*250))}),M("mesh",{name:"skybox",ref:o,position:[0,-5e3,0],rotation:[0,-1.5,0],scale:[9e5,9e5,9e5],renderOrder:0,children:[c("sphereGeometry",{args:[1,8,8]}),c(he,{baseMaterial:r.MeshBasicMaterial,fog:!1,side:r.BackSide,ref:t,uniforms:{playerPos:{value:new r.Vector3},playerDest:{value:new r.Vector3},time:{value:0},map1:{value:n},map2:{value:i}},vertexShader:`
                    varying vec2 vUv;
                    
                    varying vec3 vPos;
                    void main() {
                        vUv = uv;
                        vPos = position;
                        csm_Position = position;
                    }
                `,fragmentShader:`
                    varying vec2 vUv;
                    uniform sampler2D map1;
                    uniform sampler2D map2;
                    uniform float time;
                    uniform vec3 playerPos;
                    varying vec3 vPos;
                   
                    ${be}
                    ${_}

                    
void main() {
    vec2 uv = vUv;

    if (vPos.y < 0.0) {
        uv.y = 1.0 - vUv.y;  // basic mirror flip
    }
    
    
    if (vPos.y < 0.0) {
        uv.y = 1.0 - vUv.y;

        vec2 noisePos = vPos.xz * 12.0;
        noisePos.x += time * 0.3;

        float wave = snoise(noisePos);

        uv.x += wave * 0.005 * (smoothstep(0., -0.2, vPos.y));
        uv.y += wave * 0.005 * (smoothstep(0., -0.2, vPos.y));

    }

    vec4 tex1 = texture2D(map1, uv + vec2(time * 0.0012, 0.0));
    vec4 tex2 = texture2D(map2, uv + vec2(time * -0.0022, 0.0));

    vec3 color = vec3(0.0, 0.55, 0.95);

    color = mix(color, tex1.rgb, 0.4);
    color = mix(color, tex2.rgb, 0.3);

    if (vPos.y < 0.0) {
        color *= 0.8;
        color = mix(color, vec3(0.3, 0.8, 1.1), 0.2);
        // color = pow(color, vec3(1.2));
    }

    color = toLinear(vec4(color, 1.0)).rgb;

    csm_DiffuseColor.rgb = color;
}
                `},Math.random())]})},()=>!0),po=q(({azimuth:o=150,elevation:t=90,lightDistance:n=20,...i},s)=>{const e=w(),d=w(),a=w(),f=w();return C(()=>{a.current.target=d.current,window.dirLight=a.current,window.ambientLight=f.current},[]),G(()=>{if(window.playerPos){d.current.position.set(window.playerPos.x,window.playerPos.y,window.playerPos.z);const y=r.MathUtils.degToRad(o),p=r.MathUtils.degToRad(t),b=Math.cos(p),v=Math.sin(p),g=Math.cos(y),m=Math.sin(y),h=n*b*m,u=n*v,x=n*b*g;e.current.position.set(window.playerPos.x+h+11,window.playerPos.y+u,window.playerPos.z+x+11)}}),ee(s,()=>({group:e,directionalLight:a,ambientLight:f})),M(se,{children:[c(Xt,{near:1,background:!1,far:1e6,resolution:256,children:c(kt,{})}),c("ambientLight",{ref:f,intensity:1}),c("group",{ref:e,children:c("directionalLight",{ref:a,color:[1.2,1,.9],intensity:.75,"shadow-mapSize":[2048,2048],"shadow-camera-near":1,"shadow-camera-far":50,"shadow-camera-left":-20,"shadow-camera-right":20,"shadow-camera-top":20,"shadow-camera-bottom":-20,castShadow:!0})}),c("group",{ref:d})]})});new re;const fo=()=>{const o=vt(),t=J(()=>new re);J(()=>new Z);const n=J(()=>0),i=J(()=>0),s=w();return C(()=>{window.cloudsRef=s},[]),M(wt,{ref:s,position:[0,0,0],frustumCulled:!1,capacity:1e3,renderOrder:200,children:[c("tetrahedronGeometry",{args:[2,1]}),M(mt.meshStandardMaterial,{roughness:.99,blending:r.AdditiveBlending,depthWrite:!1,transparent:!0,opacity:.02,children:[c(V.Color,{color:gt(o.progress,[new Z(0,0,0),0],[new Z(2,1,.2),.5],[new Z(0,0,0),1])}),c(V.Rotate,{rotation:ht(ie(o.age,n))}),c(V.Rotate,{rotation:bt(ie(o.age,n))}),c(V.Scale,{scale:i}),c(V.Velocity,{direction:t,time:o.age}),c(V.Acceleration,{direction:new re(5,-.2,2),time:o.age}),c(V.Lifetime,{progress:o.progress}),c(V.SurfaceWobble,{amplitude:1.4,frequency:.1})]}),c(yt,{rate:50,setup:({mesh:e,position:d,rotation:a})=>{o.write(e,O(4,9)),window.playerPos||(window.playerPos=new r.Vector3),d.x=window.playerPos.x+O(-3e3,3e3),d.y=O(400,800),d.z=window.playerPos.z+O(-3e3,3e3),a.copy(new r.Quaternion().random()),n.write(e,$(.05)),i.write(e,O(50,80)),t.write(e,f=>f.set($(.5),O(-2,-1),$(.5)))}})]})},mo=()=>{const o=vt(),t=J(()=>new re),n=J(()=>0),i=J(()=>0);return M(wt,{frustumCulled:!1,capacity:1e3,renderOrder:9,children:[c("boxGeometry",{args:[1,1,1]}),M(mt.meshStandardMaterial,{roughness:.99,blending:r.AdditiveBlending,depthWrite:!1,transparent:!0,opacity:.3,children:[c(V.Color,{color:gt(o.progress,[new Z(0,0,0),0],[new Z(2,.3,0),.5],[new Z(0,0,0),1])}),c(V.Rotate,{rotation:ht(ie(o.age,n))}),c(V.Rotate,{rotation:bt(ie(o.age,n))}),c(V.Scale,{scale:i}),c(V.Velocity,{direction:t,time:o.age}),c(V.Acceleration,{direction:new re(-7,-.2,0),time:o.age}),c(V.Lifetime,{progress:o.progress})]}),c(yt,{rate:100,setup:({mesh:s,position:e,rotation:d})=>{o.write(s,O(4,9)),window.playerPos||(window.playerPos=new r.Vector3),e.copy(window.playerPos||new r.Vector3),e.x=window.playerPos.x+O(-200,200),e.y=window.playerPos.y+O(-200,200),e.z=window.playerPos.z+O(-200,200),d.copy(new r.Quaternion().random()),n.write(s,$(10.5)),i.write(s,O(.4,.8)),t.write(s,a=>a.set($(2.5),O(-2,-1),$(2.5)))}})]})},vo=()=>M(se,{children:[c(mo,{}),c(kt,{}),c(fo,{}),c(po,{})]}),wo=()=>{const o=w();return C(()=>{const t=o.current;t&&(window.cam=t,t.dollyTo(3,!1),t.moveTo(0,1,0,!1),t.rotateTo(-.5,Math.PI/2+.1,!1),t.minDistance=1.5,t.maxDistance=100,t.draggingSmoothTime=.015,t.smoothTime=.2,t.dollySpeed=.9,window.buildData&&(window.cam.dollyTo(4,!0),window.cam.rotateTo(Math.PI,1.2,!0)),t.mouseButtons.right=1)},[]),G(()=>{o.current.camera.position.y<.2&&(o.current.camera.position.y=.2)}),c(Yt,{makeDefault:!0,ref:o})};let le=null,de=!1,ct=null;const yo=q(({src:o="/content/609b4b19a41e89ee3274c4455036ff19ff0ae17426e4891bebf689997dbdca3bi0",animations:t={idle:"/content/a11189dd226838ec2b7689e27355e37c3d2c841645d341f9ac22ac6cac0ab645i0",walk:"/content/9c99296596aebca23b81d17c864ba6a35bd48fa8a006d1e81419a81948652326i4",run:"/content/a2a286e5fcde5450311dc657ee37b67dfd4b471e325e4c08909f0b7e4b250496i0",jump:"/content/abab52ddfe550d18c87d8102082f03dbbd7430e3c30e0c3bf7a4dea7b786bb47i0",sit:"/content/9c99296596aebca23b81d17c864ba6a35bd48fa8a006d1e81419a81948652326i0",attack:"/content/9c99296596aebca23b81d17c864ba6a35bd48fa8a006d1e81419a81948652326i3"},shadows:n=!0},i)=>{const[s,e]=X(null),d=w(null),a=w({}),f=w(null),y=w(null),p=w(new r.Group),b=(v,g=.2,m=.3,h=1)=>{var x;if(((x=f.current)==null?void 0:x._clip.name)===v)return;const u=a.current[v];if(!u){console.warn(`animation not loaded: ${v}`);return}f.current&&f.current!==u?(u.reset(),u.enabled=!0,u.setEffectiveTimeScale(h),u.setEffectiveWeight(1),f.current.crossFadeTo(u,g,!1),u.play()):(u.reset(),u.enabled=!0,u.setEffectiveTimeScale(h),u.setEffectiveWeight(1),u.fadeIn(m).play()),f.current=u,y.current=u};return ee(i,()=>({vrm:s,mixerRef:d,setAnimation:b,playAnimationOnce:(v,g=.2,m=.3,h=1)=>{var U;const u=a.current[v];if(!u){console.warn(`animation not loaded: ${v}`);return}const x=f.current;if(((U=f.current)==null?void 0:U._clip.name)===v)return;u.reset(),u.enabled=!0,u.setEffectiveTimeScale(h),u.setEffectiveWeight(1),u.loop=r.LoopOnce,u.clampWhenFinished=!0,x&&x!==u?x.crossFadeTo(u,g,!1):u.fadeIn(m),u.play(),f.current=u;const S=()=>{x&&x!==u&&(x.reset(),x.enabled=!0,x.setEffectiveTimeScale(h),x.setEffectiveWeight(1),u.crossFadeTo(x,m,!1),x.play(),f.current=x),de=!1},P=((T,L)=>(...Q)=>{clearTimeout(ct),ct=setTimeout(()=>T(...Q),L)})((T,L)=>{de||(le&&T.removeEventListener("finished",le),T.addEventListener("finished",S),le=S,L.reset(),L.enabled=!0,L.setEffectiveTimeScale(h),L.setEffectiveWeight(1),L.play(),de=!0)},100),I=u.getMixer();P(I,u)},stopAllAnimations:()=>{var v;(v=d.current)==null||v.stopAllAction(),f.current=null,y.current=null},getAvailableAnimations:()=>Object.keys(a.current)})),C(()=>((async()=>{const g=new Ht,m=new at;g.setDRACOLoader(m),g.crossOrigin="anonymous",g.register(k=>new _t(k,{helperRoot:p.current,autoUpdateHumanBones:!0})),g.register(k=>new $t(k));const h=await g.loadAsync(o),u=h.userData.vrm;H.removeUnnecessaryVertices(h.scene),H.combineSkeletons(h.scene),H.combineMorphs(u),H.rotateVRM0(u),H.removeUnnecessaryJoints(h.scene);const x=new eo(u.lookAt);if(x.name="lookAtQuaternionProxy",u.scene.add(x),u.scene.children[0].frustumCulled=!1,u.scene.children[1].frustumCulled=!1,n){try{u.scene.children[0].castShadow=!0}catch{}try{u.scene.children[1].castShadow=!0}catch{}try{u.scene.children[2].castShadow=!0}catch{}try{u.scene.children[3].castShadow=!0}catch{}try{u.scene.children[4].castShadow=!0}catch{}try{u.scene.children[5].castShadow=!0}catch{}try{u.scene.children[6].castShadow=!0}catch{}try{u.scene.children[7].castShadow=!0}catch{}try{u.scene.children[8].castShadow=!0}catch{}try{u.scene.children[9].castShadow=!0}catch{}}e(u),d.current=new r.AnimationMixer(u.scene);for(const[k,P]of Object.entries(t))try{let I;if(P.src&&P.type==="fbx")I=await to(P.src,u);else if(P.src&&P.type==="vrma"){const Q=(await g.loadAsync(P.src)).userData.vrmAnimations[0];I=it(Q,u)}else{const Q=(await g.loadAsync(P)).userData.vrmAnimations[0];I=it(Q,u)}I.name=k;const U=d.current.clipAction(I);a.current[k]=U,b("idle");let T=document.getElementById("loadCover");T&&(T.style.transition="1s",T.style.opacity="0",setTimeout(()=>{T.remove()},1e3))}catch(I){console.error(`failed to load animation: ${P}`,I)}const S=document.getElementById("loadd");S&&S.remove()})(),()=>{s&&H.deepDispose(s.scene),d.current&&d.current.stopAllAction(),new at().dispose()}),[o]),G((v,g)=>{var m;v.clock.running&&((m=d.current)==null||m.update(g),s==null||s.update(g))}),c(St,{fallback:M("mesh",{children:[c("boxGeometry",{}),c("meshNormalMaterial",{})]}),children:s?c("primitive",{object:s.scene}):null})}),go=q((o,t)=>{const n=j.useCurrentEntity(),i=w(0),[s,e]=ge(()=>({rotationY:0,config:{mass:1.1,friction:21,tension:369},onChange:d=>{n!=null&&n.rotation&&(n.rotation.y=d.value.rotationY)}}));return ee(t,()=>({ref:t,setRotationY:d=>{d!==i.current&&(i.current=d,e.start({rotationY:d}))},stop:()=>{e.stop()}})),null});q((o,t)=>{const n=j.useCurrentEntity(),[i,s]=ge(()=>({height:0,config:{mass:1.1,friction:21,tension:369},onChange:e=>{n!=null&&n.position&&(n.position.y=e.value.height)}}));return ee(t,()=>({ref:t,setHeight:(e,d)=>{s.start({height:e,config:d})},stop:()=>{s.stop()}})),null});const we=Math.PI,ue=we*2,pe=new r.Object3D,lt=new r.Euler,B=new r.Vector3,Y=new r.Vector3,ae=new r.Vector3,ho=new r.Vector3;window.moveDirection=new r.Vector3(0,0,1);const fe=new r.Vector3,dt=new r.Vector3;function bo(o,t){let n=(t-o)%ue;return n>we&&(n-=ue),n<-we&&(n+=ue),o+n}window.camFocused=!1;const xo=q((o,t)=>{const n=w(!1),i=w(),s=w("idle"),e=j.useCurrentEntity(),d=w(!1),a=w(0),{raycaster:f}=ye();G(({camera:p,clock:b},v)=>{var g,m,h,u;if(e){B.set(0,0,0),Y.set(0,0,0),ae.set(0,0,0);const x=new r.Quaternion;p.getWorldDirection(Y),Y.y=0,Y.normalize(),window.camForward=Y,ho.set(0,0,1).applyQuaternion(x).normalize(),ae.crossVectors(p.up,Y).normalize(),(window.keyDown.w||(g=window.dir)!=null&&g.includes("up"))&&B.add(Y),(window.keyDown.s||(m=window.dir)!=null&&m.includes("down"))&&B.add(Y.negate()),(window.keyDown.d||(h=window.dir)!=null&&h.includes("right"))&&B.add(ae.negate()),(window.keyDown.a||(u=window.dir)!=null&&u.includes("left"))&&B.add(ae);const S=e.speed||5,k=e.acceleration||10,P=e.deceleration||10,I=Object.values(st.state.colliders).flat(),U=y(e,v,I);if(U!=null&&U.normal&&(U==null?void 0:U.distance)<e.speed*.15&&B.add(U.normal),B.length()>0){window.moveDirection=B.clone(),!e.state.jumping&&d.current&&Date.now()>a.current+400?(window.sounds.step1.triggerAttackRelease(["F1"],.4),a.current=Date.now(),window.addFootDust({position:e.position}),setTimeout(()=>{window.addFootDust({position:e.position})},20),setTimeout(()=>{window.addFootDust({position:e.position})},50)):setTimeout(()=>{d.current=!0},400),B.normalize(),e.state.running=!0,window.playerMoving||(window.playerMoving=!0);const T=new r.Vector3(B.x*S,0,B.z*S);e.velocity.x+=(T.x-e.velocity.x)*k*v,e.velocity.z+=(T.z-e.velocity.z)*k*v;const L=Math.sqrt(e.velocity.x**2+e.velocity.z**2);if(L>S){const Q=S/L;e.velocity.x*=Q,e.velocity.z*=Q}}else{d.current&&(d.current=!1),e.state.running=!1,window.playerMoving&&(window.playerMoving=!1);const T=Math.sqrt(e.velocity.x**2+e.velocity.z**2);if(T>0){const L=Math.max(0,T-P*v)/T;e.velocity.x*=L,e.velocity.z*=L}else e.velocity.x=0,e.velocity.z=0}if(e.position.x+=e.velocity.x*v,e.position.z+=e.velocity.z*v,e.position.x>50&&(e.position.x=50),e.position.x<-50&&(e.position.x=-50),e.position.z>50&&(e.position.z=50),e.position.z<-50&&(e.position.z=-50),window.playerPos=e.position,e.state){const T=e.state.running?"run":"idle";if(T!==s.current&&e.render.model.current&&(e.render.model.current.setAnimation(T,.3,.1,1.2),s.current=T),e.rotationSpring&&B.length()>0&&e.state.running){pe.position.set(e.position.x,e.position.y,e.position.z),pe.lookAt(e.position.x+B.x,e.position.y+B.y,e.position.z+B.z),lt.setFromQuaternion(pe.quaternion,"YXZ");const L=bo(e.rotation.y,lt.y);e.rotationSpring.setRotationY(L)}}if(window.camFocused===!1){const T=window.cam.distance||1;let L=e.position.y+(1.9-T*-.03);window.cam.moveTo(e.position.x,L,e.position.z,!1)}}});const y=oe((p,b,v)=>{var x;if(window.rebasing)return null;const{velocity:g,position:m}=p;g&&m&&(g.y-=8.5*b,m.y+=g.y*b),f.set(fe.set(m.x,m.y+2,m.z),dt.set(0,-1,0)),n.current&&(n.current=!1);const h=f.intersectObjects(v);if(h[0]){const S=h[0].point.y;m.y<=S&&(p.position.y=S,p.velocity.y=0,p.intersectPosition=S,p.state.jumping=!1),p.groundNormal=h[0].normal}else{f.set(fe.set(m.x,m.y+3,m.z),dt.set(0,-1,0)),n.current&&(n.current=!1);const S=f.intersectObjects(v);if(S[0]){const k=S[0].point.y,P=m.y+p.velocity.y;P<=k?(p.position.y=k,p.velocity.y=0,p.intersectPosition=k,p.state.jumping=!1):(p.position.y=P,p.intersectPosition=null),p.groundNormal=S[0].normal}else n.current=!0,p.position.y+=p.velocity.y*b,p.intersectPosition=null}f.set(fe.set(m.x,m.y+1,m.z),Y),n.current&&(n.current=!1);const u=f.intersectObjects(v);if((x=u==null?void 0:u[0])!=null&&x.point&&i.current.position.copy(u[0].point),m.y<-0&&(m.y=-0,g.y=0),u!=null&&u[0])return u[0]},[f]);return G((p,b)=>{const v=Object.values(st.state.colliders).flat();y(e,b,v)}),M("mesh",{visible:!1,scale:.2,ref:i,children:[c("boxGeometry",{}),c("meshNormalMaterial",{})]})});let me=null;const Po=()=>(me||(me=j.world.add({isPlayer:!0,position:{x:0,y:8,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},velocity:{x:0,y:0,z:0},speed:9,acceleration:10,deceleration:50,state:{walking:!1,running:!1,jumping:!1,swimming:!1,flying:!1,mounted:!1}})),me),ko=ce(q((o,t)=>{const n=w(),i=w(),s=j.useCurrentEntity();return C(()=>{s.render||(s.render={}),s.render.model=i,s.render.group=n,window.player=s},[s]),ee(t,()=>({group:n,model:i}),[]),c("group",{ref:n,children:c(yo,{ref:i,src:"/content/609b1640c55ec583cd110cfa2dbe38759b5dd8ce0f0009ce8b8cd9af3b73ce27i0",shadows:!0,animations:{...Lt,...Ct}})})}),()=>!0),Mo=ce(()=>{const o=Po();return M(j.Entity,{entity:o,children:[c(j.Component,{name:"render",children:c(ko,{})}),c(j.Component,{name:"playerController",children:c(xo,{})}),c(j.Component,{name:"rotationSpring",children:c(go,{})})]})}),Ao=ce(()=>(It(M("div",{className:"pix absolute bottom-20 right-2 flex flex-col gap-2",children:[c("button",{onClick:()=>{window.player.render.model.current.playAnimationOnce("attack",.3,.4,1.2)},className:"p-1 px-4 text-red-300 bg-neutral-800/25",children:"attack"}),c("button",{onClick:()=>{window.player.render.model.current.playAnimationOnce("sit",.3,.4,1.2)},className:"p-1 px-4 text-lime-300 bg-neutral-800/25",children:"sit"})]})),so({onKeyDown:{" ":()=>{var n,i;const o=window.player;if(o.state.jumping)return;(i=(n=window.sounds)==null?void 0:n.jump1)==null||i.triggerAttackRelease(["F1"],.4),o.state.jumping=!0,o.velocity.y+=7,o.speed+=2;const t=o.state.mounted?o.render.mount.current:o.render.model.current;t==null||t.playAnimationOnce("jumpRoll",.3,.4,1.2),setTimeout(()=>{var s;t==null||t.setAnimation(o.state.running?"run":"idle",.4,.3,1.2),o.speed-=2,(s=window.keyDown)!=null&&s.space||(o.state.jumping=!1)},600)}}}),c("group",{children:c(Mo,{})}))),Mt=new Tone.Volume(-15).toDestination();window.sounds={};window.sounds.jump1=new Tone.Sampler({urls:{A1:"c1c1b5b643891c559a19508f424aa0f7530d71c5dd16d3f31200e58a1019b05ci0"},baseUrl:"/content/",onload:()=>{}}).connect(Mt);window.sounds.step1=new Tone.Sampler({urls:{A1:"f1f180d020e64e0fe921028527b575f73209a8574efba83b3c233888566a1ce3i0"},baseUrl:"/content/",onload:()=>{}}).connect(Mt);const zo=()=>(Tt(()=>{async function o(){try{await Tone.start(),console.log("tonejs started")}catch(t){console.error("error starting audio:",t)}}window.start=o},[]),null),Do=`
                float hash(vec2 p) {
                    return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453123);
                }

                vec2 hex(vec2 p) {
                    const mat2 M = mat2(1.0, 0.0, 0.5, 0.86602540378);
                    p = M * p;
                    vec2 g = floor(p);
                    vec2 f = fract(p);
                    vec2 off;
                    if (f.x + f.y > 1.0) {
                        off = vec2(1.0, 1.0);
                    } else {
                        off = vec2(0.0, 0.0);
                    }
                    vec2 id = g + off;
                    return id;
                }
               
               vec4 hexTexture(sampler2D tex, vec2 uv, float jit) {
              
                    vec2 cell100 = hex(uv);
                    vec2 randOffset100 = vec2(
                        hash(cell100 + vec2(1.0, 0.0)),
                        hash(cell100 + vec2(0.0, 1.0))
                    ) * jit;
                    vec2 tileUV100 = fract(uv) + randOffset100;
                    vec2 ddxUv100 = dFdx(uv);
                    vec2 ddyUv100 = dFdy(uv);
                    vec2 ddxTileUV100 = ddxUv100;
                    vec2 ddyTileUV100 = ddyUv100;

                    return textureGrad(tex, tileUV100, ddxTileUV100, ddyTileUV100);
               }


`;class Ro{constructor(t,n){this.key=t,this.value=n,this.prev=null,this.next=null}}class So{constructor(t){this.maxSize=t,this.cache={},this.head=null,this.tail=null,this.size=0}has(t){return Object.prototype.hasOwnProperty.call(this.cache,t)}get(t){const n=this.cache[t];return n?(this._moveToFront(n),n.value):null}set(t,n){let i=this.cache[t];i?(i.value=n,this._moveToFront(i)):(i=new Ro(t,n),this.cache[t]=i,this._addToFront(i),this.size++,this.size>this.maxSize&&this._removeLeastRecent())}delete(t){const n=this.cache[t];return n?(this._removeNode(n),delete this.cache[t],this.size--,!0):!1}clear(){for(const t in this.cache){const n=this.cache[t];n.value instanceof r.Texture&&n.value.dispose(),delete this.cache[t]}this.head=null,this.tail=null,this.size=0}*entries(){for(const t in this.cache)this.has(t)&&(yield[t,this.cache[t].value])}_moveToFront(t){t!==this.head&&(this._removeNode(t),this._addToFront(t))}_addToFront(t){this.head?(t.next=this.head,this.head.prev=t,this.head=t):this.head=this.tail=t}_removeNode(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev}_removeLeastRecent(){if(!this.tail)return;const{key:t,value:n}=this.tail;n instanceof r.Texture&&n.dispose(),delete this.cache[t],this._removeNode(this.tail),this.size--}}const ut=new So(25);function K(o,{uniforms:t,materialRef:n,resolution:i=1024,minFilter:s=r.LinearMipmapLinearFilter,magFilter:e=r.LinearFilter,anisotropy:d=16,wrapS:a=r.RepeatWrapping,wrapT:f=r.RepeatWrapping,encoding:y=r.sRGBEncoding,format:p=r.RGBAFormat,generateMipmaps:b=!0,frag:v=`

      varying vec2 vUv;

      void main() {
        vec3 color = vec3(1.0, 0.5, 0.0);

        gl_FragColor = vec4(color, 1.);
      }
                                    `,vert:g=`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = vec4(position, 1.0);
      }
    `}={},m,h){const u=ut.get(o);if(u)return u;const x=new r.WebGLRenderTarget(i,i,{minFilter:s,magFilter:e,format:r.RGBAFormat,generateMipmaps:!0,anisotropy:d||m.capabilities.getMaxAnisotropy(),wrapS:r.RepeatWrapping,wrapT:r.RepeatWrapping,encoding:r.sRGBEncoding}),S=new r.ShaderMaterial({uniforms:t,vertexShader:g,fragmentShader:v}),k=new r.Mesh(new r.PlaneGeometry(2,2),S);h.position.x=0,h.position.y=0,h.position.z=0,m.setRenderTarget(x),m.render(k,h),m.generateMipmaps=!0,x.texture.generateMipmaps=!0,m.setRenderTarget(null);const P=x.texture;return P.wrapS=P.wrapT=r.RepeatWrapping,P.repeat.set(1,1),P.minFilter=s,P.magFilter=e,P.encoding=r.sRGBEncoding,P.premultiplyAlpha=!1,P.format=r.RGBAFormat,P.anisotropy=d||m.capabilities.getMaxAnisotropy(),P.needsUpdate=!0,ut.set(o,P),P}const To=o=>(o?(o=o.replace(/void\s+main\s*\(\s*\)\s*{/,"void main() {vec3 color = vec3(0.5, 0.2, 0.0); float a = 1.0;"),o=o.replace(/\}\s*$/,"")):(console.log("nop"),o="void main() {vec3 color = vec3(0.9, 0.6, 0.0); float a = 1.0;"),`
    varying vec2 vUv;
    varying vec3 vPosition;
    varying vec3 vNormalWorld;
    varying vec3 vViewDirection;
    varying vec2 edgeDistance;
    varying float verticalFactor;
    
    uniform float lastRebaseTime;
    uniform float time;
    uniform vec3 playerPosition;
    ${Do}
    ${be}
    

      ${o}
      
        
      
      // fog fade
      // float playerDistance = distance(vPosition.xz, playerPosition.xz);
      // color = mix(color, vec3(0.9, 0.9, 0.9), smoothstep(0., 2000., playerDistance) * 0.2);

      // opacity edge fade
      // a -= smoothstep(1500., 3000., abs(edgeDistance.x));
      // a -= smoothstep(1500., 3000., abs(edgeDistance.y));
      // a = clamp(a, 0.2, 1.0);

      // new chunk smooth fade-in
      // float rebaseDiff = clamp((time - lastRebaseTime) * 0.2, 0.0, 0.2);
      // if (edgeDistance.x > 3000.0 || edgeDistance.y > 3000.0) {
      //   a = rebaseDiff;
      // }

      csm_DiffuseColor.rgb = toLinear(vec4(clamp(color, 0.0, 1.0), 1.0)).rgb;
      csm_DiffuseColor.a = clamp(a, 0.0, 1.0);
    }
  `),Fo=({offsetX:o=0,offsetY:t=0,...n})=>{var ze,De,Re,Se,Te,Fe,Ee,Le,Ce,Ue,We,Be,Ve,je,Ie,Ne,Oe,Ge,Qe,Xe,Ye,Ke,Ze,Je,qe,He,_e,$e,et,tt,ot,rt;const i=w(),{gl:s,camera:e,scene:d}=ye(),{terrain:{material:a}}=n,f=`
    varying vec2 vUv;
    varying vec3 vPosition;
    varying vec3 vNormalWorld;
    varying vec3 vViewDirection;
    varying vec2 edgeDistance;
    varying float verticalFactor;
    
    uniform vec2 offset; //just neededfor builder
    uniform vec3 playerPos;
    void main() {
      vUv = uv;
      
      //custom for builder single mesh offsets
      vPosition = (position + vec3(offset.x, -offset.y, 0.)).xzy;
      
      vNormalWorld = normalize(mat3(modelMatrix) * normal);
      vViewDirection = normalize(cameraPosition - vPosition);
      edgeDistance = vec2(abs(vPosition.x - playerPos.x), abs(vPosition.z - playerPos.z));
      verticalFactor = 1. - abs(vNormalWorld.y);
      
      csm_Position = position;
    }
  `,{finalFragmentShader:y}=te(()=>({finalFragmentShader:To(a.customFragmentShader)}),[a,o,t,s]);G(l=>{var A,z,D,R;(z=(A=i.current)==null?void 0:A.uniforms)!=null&&z.time&&(i.current.uniforms.time.value=l.clock.elapsedTime),window.playerPos&&((R=(D=i.current)==null?void 0:D.uniforms)!=null&&R.playerPosition)&&(i.current.uniforms.playerPosition.value={x:window.playerPos.x,y:window.playerPos.y,z:-window.playerPos.z})});const p="/content/cfab194b924f7785c6e453728e1c264b89b74843633278cda3ad3f57576c1e93i0",b=N(((De=(ze=a.textures)==null?void 0:ze[0])==null?void 0:De.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=16,l.needsUpdate=!0}),v=N(((Se=(Re=a.textures)==null?void 0:Re[1])==null?void 0:Se.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=16,l.needsUpdate=!0}),g=N(((Fe=(Te=a.textures)==null?void 0:Te[2])==null?void 0:Fe.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=1,l.needsUpdate=!0}),m=N(((Le=(Ee=a.textures)==null?void 0:Ee[3])==null?void 0:Le.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=1,l.needsUpdate=!0}),h=N(((Ue=(Ce=a.textures)==null?void 0:Ce[4])==null?void 0:Ue.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=1,l.needsUpdate=!0}),u=N(((Be=(We=a.textures)==null?void 0:We[5])==null?void 0:Be.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=1,l.needsUpdate=!0}),x=N(((je=(Ve=a.textures)==null?void 0:Ve[6])==null?void 0:je.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=1,l.needsUpdate=!0}),S=N(((Ne=(Ie=a.textures)==null?void 0:Ie[7])==null?void 0:Ne.src)||p,l=>{l.wrapS=r.RepeatWrapping,l.wrapT=r.RepeatWrapping,l.magFilter=r.LinearFilter,l.minFilter=r.LinearMipmapLinearFilter,l.generateMipmaps=!0,l.encoding=r.sRGBEncoding,l.anisotropy=1,l.needsUpdate=!0}),[k,P]=X(null);C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[0])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[0])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[0])==null?void 0:E.bakeData,s,e);P(W)}})()},[P,a]);const[I,U]=X(null);C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[1])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[1])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[1])==null?void 0:E.bakeData,s,e);U(W)}})()},[U,a]);const[T,L]=X(null);C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[2])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[2])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[2])==null?void 0:E.bakeData,s,e);L(W)}})()},[L,a]);const[Q,xe]=X(null);C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[3])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[3])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[3])==null?void 0:E.bakeData,s,e);xe(W)}})()},[xe,a]);const[At,Pe]=X(null);C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[4])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[4])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[4])==null?void 0:E.bakeData,s,e);Pe(W)}})()},[Pe,a]);const[zt,ke]=X(null);C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[5])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[5])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[5])==null?void 0:E.bakeData,s,e);ke(W)}})()},[ke,a]);const[Dt,Me]=X(null);C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[6])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[6])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[6])==null?void 0:E.bakeData,s,e);Me(W)}})()},[Me,a]);const[Rt,Ae]=X(null);return C(()=>{(async()=>{var A,z,D,R,F,E;if((z=(A=a.textures)==null?void 0:A[7])!=null&&z.bakeData){const W=await K((R=(D=a.textures)==null?void 0:D[7])==null?void 0:R.name,(E=(F=a.textures)==null?void 0:F[7])==null?void 0:E.bakeData,s,e);Ae(W)}})()},[Ae,a]),Ft(he,{baseMaterial:a.baseMaterial||r.MeshToonMaterial,color:"#000",...a,ref:i,depthTest:!0,depthWrite:!0,transparent:!0,fog:!1,key:`${a.customFragmentShader}`,uniforms:{offset:{value:[o,t]},playerPosition:{value:new r.Vector3},time:{value:0},lastRebaseTime:{value:0},[((Ge=(Oe=a.textures)==null?void 0:Oe[0])==null?void 0:Ge.name)||"texture0"]:{value:k||b},[((Xe=(Qe=a.textures)==null?void 0:Qe[1])==null?void 0:Xe.name)||"texture1"]:{value:I||v},[((Ke=(Ye=a.textures)==null?void 0:Ye[2])==null?void 0:Ke.name)||"texture2"]:{value:T||g},[((Je=(Ze=a.textures)==null?void 0:Ze[3])==null?void 0:Je.name)||"texture3"]:{value:Q||m},[((He=(qe=a.textures)==null?void 0:qe[4])==null?void 0:He.name)||"texture4"]:{value:At||h},[(($e=(_e=a.textures)==null?void 0:_e[5])==null?void 0:$e.name)||"texture5"]:{value:zt||u},[((tt=(et=a.textures)==null?void 0:et[6])==null?void 0:tt.name)||"texture6"]:{value:Dt||x},[((rt=(ot=a.textures)==null?void 0:ot[7])==null?void 0:rt.name)||"texture7"]:{value:Rt||S}},vertexShader:f,fragmentShader:y})},Eo={terrain:{material:{textures:[{name:"grass1c_tex",src:"/content/ffffd8896b00f50266e3e590a0bdba4b07cd8815c17852e0666929a8d5c076aci0"},{name:"grass1ao_tex",src:"/content/a0a0bb64a8aac923ccb68d76a54a7fa66ea29c7933292912b165e7bfc7158e8di0"},{name:"stones1_tex",src:"/content/b33bca68fbf22491b83d631fa31bc2f32fddda4da8041e586cac32a5a32a072ci0"},{name:"stones1ao_tex",src:"/content/a0396224b1409779d71f328d84732ea41c8cdbd1060e153e02e2b387fd1757d1i0"},{name:"road1c_tex",src:"/content/dddd56c10b012f78ee862429de31f1c31f4b8d7792b9a69ac26bbff42ebb6b5di0"},{name:"baked1_tex",bakeData:{resolution:512,uniforms:{},frag:`

           ${_}
          uniform float time;
          varying vec2 vUv;

          void main() {
            vec3 color = vec3(1.0, 1.0, 1.0);

            float n1 = snoise(vUv * 999.);
            
            color.rgb = vec3(step(0.1, n1));

            gl_FragColor = vec4(color, 1.);
          }
                                        `}},{name:"baked2_tex",bakeData:{resolution:512,uniforms:{},frag:`

           ${_}
           ${qt}
         uniform float time;
          varying vec2 vUv;

          void main() {
            vec3 color = vec3(1.0, 1.0, 1.0);

            float n1 = fract(snoise(vUv * 80.));
            float n2 = fract(snoise(vUv * 9.));
            float n3 = fract(snoise(vUv * 4.));
            
            color.rgb = vec3(n1+n2);
            
            color.b = step(0.9, n3);

            gl_FragColor = vec4(color, 1.);
          }
                                        `}}],customFragmentShader:`
            
uniform sampler2D grass1c_tex;
uniform sampler2D grass1ao_tex;
uniform sampler2D road1c_tex;
uniform sampler2D baked1_tex;
uniform sampler2D baked2_tex;
uniform sampler2D stones1_tex;
uniform sampler2D stones1ao_tex;
                
                ${_}
            
void main() {
                    vec3 bake1 = texture2D(baked1_tex, (vUv * 25. + time * 0.004)).rgb;
                    vec3 bake2 = texture2D(baked1_tex, (vUv *0.6 + vec2(time * 0.002, 0.))).rgb;
                    // vec3 bake3 = texture2D(baked1_tex, (vUv * 0.5 + time * 0.002)).rgb;
                    
                    vec3 bakeBig = texture2D(baked2_tex, (vUv * 10.0)).rgb;
                    
                    vec3 grass1c = hexTexture(grass1c_tex, vUv * 100., 100.).rgb * 1.25;
                    color = grass1c;
                    
                    vec3 grass1ao = hexTexture(grass1ao_tex, vUv * 100., 100.).rgb;
                    color = mix(color, color * grass1ao.rgb, bake1.r + 0.7 * bake2);
                    
                    vec3 grass1c_big = hexTexture(grass1c_tex, vUv * 50., 33.).rgb * 0.5;
                    color -= bake2 * 0.03 * grass1c_big;

                    // color = mix(color, color * grass1c_big.rgb, 0.7);

                    color -= grass1c_big.grb * 0.7;


                    color = mix(color, vec3(0.5, 0.9, 1.7), smoothstep(10., 500., vPosition.y) * 0.2);

                    // color = mix(color, color * vNormal_world.y, 0.7);

                    vec3 stones1 = hexTexture(stones1_tex, vUv * 200., 100.).rgb;
                    vec3 stones1ao = hexTexture(stones1ao_tex, vUv * 200., 100.).rgb;

                vec3 path = mix(stones1, stones1 * stones1ao, (bake1.r * 2.4) * (bake2.r * 0.2)) * 0.8;
                



                    float dist = distance(vPosition.xz, playerPosition.xz);
                    

                color.g -= bakeBig.r * 0.05;
                
                    color = mix(color, color * (1. + grass1ao), smoothstep(8., 0., dist) * 0.2);
                    

                    color -= smoothstep(1.4, -0.4, dist) * 0.15;
                    

color.b *= 0.9;
color.r *= 0.9;

// color -= (1. - smoothstep(0., 60., vPosition.y)) * 0.1;
// color.b += (smoothstep(20., 100., vPosition.y)) * 0.1;
// color.rg += (smoothstep(70., 200., vPosition.y)) * 0.1;
// color -= (1. - smoothstep(0., 40., vPosition.y)) * 0.04;

                    color *= 1.6;
                    
                    
                  
vec3 bake3 = hexTexture(baked1_tex, vUv * 0.5 + (time * -0.001), 100.).rgb;
 

            `}}},ve=new r.PlaneGeometry(1,1,1,2),Lo=()=>{const o=w(),t=w(),n=w(),i=w(new r.Vector3);G(y=>{if(window.playerPos&&n.current&&y.clock.running){const p=n.current.uniforms;p.time.value=y.clock.elapsedTime,p.playerPosition.value=window.playerPos,p.playerLagPos.value=i.current,i.current.lerp(window.playerPos,.2)}});const s=oe(y=>{if(t.current){let p=0;y.forEach(b=>{let v=b[0]||0,g=b[1]||0,m=b[2]||0;const h=Math.abs(Math.sin(v-g*1e5)*.1)+.1;t.current.attributes.worldPos.array[p]=v,t.current.attributes.worldPos.array[p+1]=g,t.current.attributes.worldPos.array[p+2]=m,t.current.attributes.worldPos.array[p+3]=h,p+=4}),t.current.instanceCount=p/4,t.current.attributes.worldPos.needsUpdate=!0}},[]);C(()=>{window.update_grass1=s},[s]);const e=N("data:image/webp;base64,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");C(()=>{e.flipY=!0,e.wrapS=r.RepeatWrapping,e.wrapT=r.RepeatWrapping,e.magFilter=r.LinearFilter,e.minFilter=r.LinearMipmapLinearFilter,e.generateMipmaps=!0,e.encoding=r.sRGBEncoding,e.anisotropy=1,e.needsUpdate=!0},[e]);const d=te(()=>({time:{value:0},zoom:{value:1},playerPosition:{value:new r.Vector3(0,0,0)},playerLagPos:{value:new r.Vector3},map1:{value:e}}),[e]),a=te(()=>`
        uniform float time;
        attribute vec4 worldPos;
        varying vec2 vUv;
        varying vec4 vWorldPos;
        varying vec3 vPos;
        uniform vec3 playerPosition;
        uniform vec3 playerLagPos;

        ${_}

        void main() {
            vUv = uv;
            vPos = position;

            vec3 objectPos = worldPos.xyz;

            vec3 toCamera = normalize(cameraPosition - objectPos);

            float angle = -atan(toCamera.x, toCamera.z);
            mat3 yRotation = mat3(
                cos(angle),  0.0, sin(angle),
                0.,         1.0, 0.0,
                -sin(angle), 0.0, cos(angle)
            );
            
            vec3 scale = vec3(worldPos.w, worldPos.w*1.5, worldPos.w);
            vec3 finalPosition = objectPos + (yRotation * position  * scale + vec3(0., scale.y*0.5, 0.));
            
            
            
            
    float playerDist = distance(playerPosition, worldPos.xyz);
    float playerLagDist = distance(playerLagPos, worldPos.xyz);
    float moveGap = clamp(playerLagDist - playerDist, 0., 0.3);

    float maxDist = 0.9;
    float maxDisplacement = 3.1;

    if (playerDist < maxDist) {
        vec3 direction = normalize(worldPos.xyz - playerPosition);
        
        float strength = 0.2 + smoothstep(maxDist, -0.5, playerDist) * sin(moveGap * (time*0.004));
        
        finalPosition += direction * strength * maxDisplacement * (((position.y+0.5) * (position.y+0.5)));
    }
    
    
    
            
            if (position.y > -0.1) {
                
    float n1 = snoise(worldPos.xz * 5.4 + (time * 0.5));
    float n2 = abs( snoise(worldPos.xz * 0.01 + (time * 0.13)));

    finalPosition.x -= (n2 * 3. + n1) * (((position.y * position.y) +0.1) * 0.9);
            }

            vWorldPos = worldPos;
            csm_Position = finalPosition;
            // csm_Position = (position * sin(worldPos.x*worldPos.z*1000.) + vec3(0., 0.5, 0.)) + worldPos.xyz;
        }
    `),f=te(()=>`
        varying vec2 vUv;
        uniform sampler2D map1;
        uniform float time;
        uniform vec3 playerPosition;
        varying vec3 vPos;
        varying vec4 vWorldPos;

 
        ${be}
        ${_}

        void main() {
        vec4 grass = texture2D(map1, vUv*0.95);
            vec3 color = grass.rgb * 1.0;
            color.r *= vWorldPos.w * 5.0;
            color.b *= 0.8;
            float a = grass.a;
            float dist = distance(vWorldPos.xyz, playerPosition.xyz);
            float camDist = distance(vWorldPos.xyz, cameraPosition.xyz);
            
            a -= smoothstep(0., 60., dist);
            
             if (camDist < 4.) {
                        a *= smoothstep(0., 4., camDist);
                    }
                    
            
            // color.r = vUv.x;
            // color.b = vUv.y;
            // color = vec3(0., 1., 0.);
            a = clamp(a, 0.0, 0.9);
            color = clamp(color, 0.0, 1.0);

            csm_DiffuseColor.rgb = toLinear(vec4(color, 1.0)).rgb;
            csm_DiffuseColor.a = a;
        }
    `);return M("mesh",{ref:o,frustumCulled:!1,renderOrder:90,children:[c("instancedBufferGeometry",{name:"grass-instances",ref:t,index:ve.index,"attributes-position":ve.attributes.position,"attributes-uv":ve.attributes.uv,instanceCount:0,children:c("instancedBufferAttribute",{attach:"attributes-worldPos",args:[new Float32Array(new Array(1e4*4).fill(0)),4]})}),c(he,{ref:n,baseMaterial:r.MeshToonMaterial,transparent:!0,fog:!1,depthWrite:!1,blending:r.AdditiveBlending,uniforms:d,vertexShader:a,fragmentShader:f})]})},Co=ft.memo(Lo);window.noise=oo(ro(1));Pt.Worley.setSeed(1);window.tooloud=Pt;const pt=(o,t,n=12345)=>{const i=Math.floor(o),s=Math.floor(t);let e=Math.abs(i*374761393+s*668265263+n|0);return e^=e>>16,e*=2246822507,e^=e>>13,e*=3266489909,e^=e>>16,e/4294967295*3-1},Uo=()=>{const o=w(new r.Vector3(-5e3,0,0)),n=50/2,i=1,s=.8,e=5;return C(()=>{const d=setInterval(()=>{if(!window.playerPos)return;const a=new r.Vector3(window.playerPos.x,0,window.playerPos.z);if(a.distanceTo(o.current)<e)return;const f=Math.round(a.x/i)*i,y=Math.round(a.z/i)*i,p=new r.Vector3(f,0,y);if(p.distanceTo(o.current)<5)return;o.current.copy(p);const b=[];for(let v=-n;v<n;v++)for(let g=-n;g<n;g++){const m=f+v*i,h=y+g*i;if(m>50||m<-50||h>50||h<-50)return;const u=pt(m,h,12345)*s,x=pt(m,h,67890)*s,S=m+u,k=h+x,P=0;b.push([S,P,k])}window.update_grass1(b)},500);return()=>{clearInterval(d)}},[]),C(()=>{window.playerPos&&o.current.set(-1e4,0,0)},[]),null},Wo=({offsetX:o=0,offsetY:t=0,worldOffsetX:n=-500,worldOffsetY:i=-500,resolution:s=100})=>{const e=w();xt(e,null,!0);const d=N("/content/826ef7605750909f7d02c5717b7b366abfd527296c6789c1ded6b9860682c541i3");return C(()=>{d.flipY=!1,d.wrapS=r.RepeatWrapping,d.wrapT=r.RepeatWrapping,d.magFilter=r.LinearFilter,d.minFilter=r.LinearMipmapLinearFilter,d.generateMipmaps=!0,d.encoding=r.sRGBEncoding,d.anisotropy=2,d.repeat.x=10,d.repeat.y=10,d.needsUpdate=!0},[d]),M(se,{children:[c(Uo,{}),c(Co,{}),M("group",{ref:e,position:[0,0,0],scale:1,children:[M("mesh",{receiveShadow:!0,rotation:[-Math.PI/2,0,0],children:[c("planeGeometry",{args:[100,100,1,1]}),c(Fo,{...Eo})]}),M("mesh",{position:[0,-50.02,0],scale:[100,100,100],children:[c("boxGeometry",{}),c("meshStandardMaterial",{metalness:-2,color:"#fff337",map:d})]})]})]})},Bo=Kt({time:0,zoom:1,playerPos:new r.Vector3,playerLagPos:new r.Vector3,cameraPos:new r.Vector3},`
    uniform float time;
    uniform vec3 cameraPos;
    attribute vec4 worldPos;
    varying vec2 vUv;
    varying vec4 vWorldPos;

    void main() {
      vUv = uv.xy;
      vWorldPos = worldPos;
      
      float timeSinceSpawn = (time - worldPos.w);
      
      float initialVelocity = 11.0;
      float gravity = 60.0;
      float yOffset = initialVelocity * timeSinceSpawn - 0.5 * gravity * timeSinceSpawn * timeSinceSpawn;
      
      vec3 objectPos = worldPos.xyz;
      objectPos.y += yOffset * 0.4;
      objectPos.x += yOffset * sin(worldPos.w*1000.) * 0.2;
      objectPos.z += yOffset * sin(worldPos.w*8241.) * 0.2;
      
      vec3 toCamera = normalize(cameraPos - objectPos);
      vec3 up = vec3(0.0, 1.0, 0.0);
      vec3 right = normalize(cross(up, toCamera));
      up = normalize(cross(toCamera, right));
      
      mat3 billboardMatrix = mat3(
        right,
        up,
        toCamera
      );
      
      float scale = 0.1 + (yOffset*0.05);
      vec3 localPos = billboardMatrix * (position * scale);
      
      vec4 worldPosition = vec4(localPos + objectPos, 1.0);
      
      gl_Position = projectionMatrix * modelViewMatrix * worldPosition;
    }
  `,`
    uniform float time;
    uniform float zoom;
    uniform vec3 playerPos;
    uniform vec3 playerLagPos;
    varying vec2 vUv;
    varying vec4 vWorldPos;

    void main() {
      
      vec3 c = vec3(0.1, 0.4, 0.1)*0.5;
      float a = 0.8 * (1.5 - (time - vWorldPos.w));
      
      gl_FragColor = vec4(c, a);
    }
  `,o=>{o.transparent=!0,o.blending=r.AdditiveBlending});jt({DamageNumberMaterial:Bo});const Vo=()=>{const o=w(),t=w(),n=w([]),{clock:i,camera:s}=ye(),e=te(()=>new r.PlaneGeometry(1,1),[]);G(()=>{if(!o.current||!t.current)return;const a=i.elapsedTime;n.current=n.current.filter(y=>a-y.spawnTime<1);let f=0;n.current.forEach(y=>{let p=y.x||0;y.y;let b=y.z||0;t.current.attributes.worldPos.array[f]=p,t.current.attributes.worldPos.array[f+1]=0,t.current.attributes.worldPos.array[f+2]=b,t.current.attributes.worldPos.array[f+3]=y.spawnTime,f+=4}),o.current.material.uniforms.time.value=a,o.current.material.uniforms.cameraPos.value.copy(s.position),t.current.instanceCount=f/4,t.current.attributes.worldPos.needsUpdate=!0});const d=oe(({position:a})=>{const f=i.elapsedTime;n.current.push({x:(a.x||window.playerPos.x)+Math.random()*.2,y:a.y||window.playerPos.y+1.5,z:(a.z||window.playerPos.z)+Math.random()*.2,spawnTime:f});let y=0;n.current.forEach(p=>{let b=p.x||0,v=p.y||0,g=p.z||0;t.current.attributes.worldPos.array[y]=b,t.current.attributes.worldPos.array[y+1]=v,t.current.attributes.worldPos.array[y+2]=g,t.current.attributes.worldPos.array[y+3]=p.spawnTime,y+=4}),t.current.instanceCount=y/4,t.current.attributes.worldPos.needsUpdate=!0},[]);return C(()=>{window.addFootDust=d;const a=f=>{f.key==="i"&&t.current&&d({position:window.playerPos})};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[d]),M("mesh",{ref:o,frustumCulled:!1,renderOrder:500,children:[M("instancedBufferGeometry",{name:"foot-dust-vfx",ref:t,index:e.index,"attributes-position":e.attributes.position,"attributes-uv":e.attributes.uv,instanceCount:0,children:[c("instancedBufferAttribute",{attach:"attributes-worldPos",args:[new Float32Array(new Array(200*4).fill(0)),4]}),c("instancedBufferAttribute",{attach:"attributes-numberIndex",args:[new Float32Array(new Array(200).fill(0)),1]})]}),c("damageNumberMaterial",{})]})},jo=()=>{const o=w(null),t=w();return G(()=>{t.current.position.y=Math.abs(Math.sin(Date.now()*5e-4)*10)}),xt(o,null,!1),c("group",{ref:o,position:[3,0,-2],children:M(Zt,{limit:5,castShadow:!0,receiveShadow:!0,children:[c("boxGeometry",{}),c("meshStandardMaterial",{roughness:.4,metalness:-.1,color:"#ff9900"}),c(nt,{position:[4,.5,11],scale:[5,4,5]}),c(nt,{ref:t,position:[-4,1.5,11],scale:[5,4,5]})]})})},Io=Wt({metadata:{name:"character-controller-demo",systems:[{src:ao},{src:io},{src:zo},{src:uo},{src:vo},{src:wo},{src:Ao},{src:Wo},{src:Vo},{src:jo}],canvas:{onPointerMissed:()=>{var n,i;console.log("canvas click (onPointerMissed)");const o=window.player;if(o.state.jumping)return;(i=(n=window.sounds)==null?void 0:n.jump1)==null||i.triggerAttackRelease(["F1"],.4),o.state.jumping=!0,o.velocity.y+=7,o.speed+=2;const t=o.state.mounted?o.render.mount.current:o.render.model.current;t==null||t.playAnimationOnce("jumpRoll",.3,.4,1.2),setTimeout(()=>{t==null||t.setAnimation(o.state.running?"run":"idle",.4,.3,1.2),o.speed-=2,o.state.jumping=!1},600)},style:{zIndex:0},shadows:!0,dpr:1,camera:{near:.5,far:1e6,fov:80},gl:{alpha:!1,antialias:!1,depth:!1,stencil:!1,powerPreference:"high-performance",precision:"highp",preserveDrawingBuffer:!1}}}}),No=()=>{const{metadata:o}=Bt(Io);return c("div",{className:"w-full h-full flex border-3 border-[#333]",children:c(Ut,{...o})})},Oo=()=>{const o=w(null),t=50,n=s=>{let e="";s>=-22.5&&s<22.5?e="right":s>=22.5&&s<67.5?e="downright":s>=67.5&&s<112.5?e="down":s>=112.5&&s<157.5?e="downleft":s>=157.5||s<-157.5?e="left":s>=-157.5&&s<-112.5?e="upleft":s>=-112.5&&s<-67.5?e="up":s>=-67.5&&s<-22.5&&(e="upright"),window.dir=e},i=no(({movement:[s,e],down:d,event:a})=>{a.preventDefault(),a.stopPropagation();let f=s,y=e;const p=Math.hypot(f,y);if(p>t){const b=Math.atan2(y,f);f=Math.cos(b)*t,y=Math.sin(b)*t}if(o.current&&(o.current.style.transform=`translate3d(${f}px, ${y}px, 0) translate(-50%, -50%)`),p>10){const b=Math.atan2(y,f)*180/Math.PI;n(b)}else window.dir="";d||(o.current&&(o.current.style.transform="translate3d(0px, 0px, 0) translate(-50%, -50%)"),window.dir="")},{from:()=>[0,0],preventDefault:!0,eventOptions:{passive:!1}});return c(se,{children:c("div",{className:"w-[120px] h-[120px] border-4 border-opacity-20 hover:border-opacity-80 border-orange-400 bg-neutral-800 bg-opacity-20 rounded-sm",style:{touchAction:"none"},children:M("div",{...i(),ref:o,className:"ring-4 ring-black ring-opacity-10 cursor-crosshair joystick-handle absolute left-1/2 top-1/2 w-[80px] h-[80px] bg-orange-400 rounded-sm",style:{transform:"translate3d(0px, 0px, 0) translate(-50%, -50%)",touchAction:"none",userSelect:"none",willChange:"transform"},children:[c("div",{className:"absolute left-1/2 -top-1 transform -translate-x-1/2 text-orange-300 text-lg",children:""}),c("div",{className:"absolute right-0.5 top-1/2 transform -translate-y-1/2 text-orange-300 text-lg",children:""}),c("div",{className:"absolute left-1/2 -bottom-1 transform -translate-x-1/2 text-orange-300 text-lg",children:""}),c("div",{className:"absolute left-0.5 top-1/2 transform -translate-y-1/2 text-orange-300 text-lg",children:""})]})})})},Go=()=>window.innerWidth<250?M("div",{className:"border-4 border-orange-400 pix text-[14px] text-lime-400 flex w-full h-full bg-gradient-to-b from-[#444] to-[#222] flex-col justify-center items-center",children:[c("div",{className:"text-[12px] pb-4",children:"react-three-fiber"}),c("div",{children:"VRM character"})]}):M("div",{className:"w-full h-full flex flex-col bg-neutral-800 ",children:[c("div",{id:"loadd",style:{zIndex:1e13},className:"absolute top-0 left-0 w-full h-full bg-neutral-700 flex justify-center items-center pix text-orange-300",children:"loading VRM character demo.."}),c(Jt,{}),c(No,{}),window.innerWidth>250?c("div",{className:"absolute bottom-8 left-8",children:c(Oo,{})}):null,window.innerWidth>250?M("div",{className:"select-none pointer-events-none px-2 bg-neutral-800/25 pix text-orange-300 text-[14px] absolute bottom-0 right-0 w-fit h-16 flex flex-col items-center justify-center",children:[M("div",{className:" flex",children:["move: ",c("span",{className:"text-lime-400 px-1",children:"WASD"})," keys"]}),M("div",{className:" flex text-yellow-300 text-[12px]",children:["jump: ",c("span",{className:"text-lime-300 px-1",children:"[space bar]"})," or tap screen"]})]}):null]});Et.createRoot(document.getElementById("root")).render(c(ft.StrictMode,{children:c(Go,{})}));</script>
  <style rel="stylesheet">@font-face{font-family:DogicaPixel;creator:"https://www.patreon.com/rmocci";src:url(/content/42338922f7f75874528b6a5b7e6b43b89936fcc623cccb7b5dabcad7c9923aaci0)}html,body,#root{margin:0;width:100%;height:100%;background:#111;position:fixed;-webkit-overflow-scrolling:auto}.pix{letter-spacing:-1px;font-family:DogicaPixel,sans-serif}</style>
</head>
<body style="background: #111">
<div id="root">
</div>

</body>
</html>
